<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; frame-ancestors 'none';">
    <title>Payment Success - SONG-NEXUS</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Orbitron:wght@700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .success-container {
            max-width: 600px;
            margin: 60px auto;
            padding: 40px;
            text-align: center;
            background: rgba(0, 204, 119, 0.05);
            border: 2px solid var(--accent-teal);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 204, 119, 0.3);
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .success-title {
            font-size: 32px;
            color: var(--accent-teal);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .success-message {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .track-info {
            background: rgba(0, 204, 119, 0.1);
            border: 1px solid rgba(0, 204, 119, 0.2);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: left;
        }

        .track-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .track-info-label {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .track-info-value {
            color: var(--accent-teal);
            font-weight: 700;
        }

        .status-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .status-error {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            color: #ff5459;
            margin-bottom: 30px;
            background: rgba(255, 84, 89, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 84, 89, 0.2);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 204, 119, 0.3);
            border-top-color: var(--accent-teal);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .button-group .button {
            flex: 1;
            min-width: 150px;
            padding: 12px 24px;
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-details {
            background: rgba(255, 84, 89, 0.05);
            border: 1px solid rgba(255, 84, 89, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">üåô</button>

    <div class="container">
        <div class="success-container">
            <div class="success-icon">‚úÖ</div>
            <h1 class="success-title">Payment Successful!</h1>

            <div id="statusContainer" class="status-loading">
                <span class="spinner"></span>
                <span>Processing your purchase...</span>
            </div>

            <div id="errorContainer" class="status-error" style="display: none;">
                <div id="errorMessage"></div>
            </div>

            <div id="trackInfo" class="track-info" style="display: none;">
                <div class="track-info-row">
                    <span class="track-info-label">üéµ Track:</span>
                    <span class="track-info-value" id="trackName">-</span>
                </div>
                <div class="track-info-row">
                    <span class="track-info-label">üë§ Artist:</span>
                    <span class="track-info-value" id="trackArtist">-</span>
                </div>
                <div class="track-info-row">
                    <span class="track-info-label">üí∞ Price:</span>
                    <span class="track-info-value" id="trackPrice">-</span>
                </div>
                <div class="track-info-row">
                    <span class="track-info-label">üìÖ Date:</span>
                    <span class="track-info-value" id="purchaseDate">-</span>
                </div>
                <div class="track-info-row">
                    <span class="track-info-label">üìå Transaction ID:</span>
                    <span class="track-info-value" id="transactionId"
                        style="font-size: 12px; word-break: break-all;">-</span>
                </div>
            </div>

            <p class="success-message" id="successMessage">
                Your purchase has been completed successfully! Your track is now available for download and streaming.
            </p>

            <div class="button-group">
                <button class="button" id="downloadBtn" onclick="downloadTrack()" style="display: none;">
                    ‚¨áÔ∏è Download Track
                </button>
                <button class="button" onclick="goToLibrary()" id="libraryBtn">
                    üìö Go to Library
                </button>
                <button class="button button-secondary" onclick="goHome()" id="homeBtn">
                    üè† Back to Home
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // PAYMENT SUCCESS PAGE - FIXED VERSION
        // ========================================================================

        let purchasedTrackData = null;
        let paymentProcessed = false;

        // FIX #1: Dynamic API Base URL
        function getApiBaseUrl() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            // Backend typically runs on port 3000, adjust if needed
            const port = hostname === 'localhost' ? ':3000' : '';
            return `${protocol}//${hostname}${port}`;
        }

        // FIX #2: Dynamic Frontend Base URL
        function getBaseUrl() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port ? `:${window.location.port}` : '';
            return `${protocol}//${hostname}${port}`;
        }

        // FIX #3: Proper error handling with retry logic
        async function initializePaymentSuccess() {
            try {
                // Get URL parameters from PayPal redirect
                const params = new URLSearchParams(window.location.search);
                const paypalToken = params.get('token');
                const paypalPayerId = params.get('PayerID');
                const jwt = localStorage.getItem('token');

                if (!jwt) {
                    showError('Authentication failed. Please log in again.', 'NO_AUTH');
                    return;
                }

                // Get pending order from localStorage
                const orderId = localStorage.getItem('pendingPaymentOrderId');
                const trackId = localStorage.getItem('pendingTrackId');

                if (!orderId || !trackId) {
                    showError('No pending payment found. Please try again.', 'NO_PENDING_ORDER');
                    return;
                }

                if (!paypalToken) {
                    showError('Invalid PayPal callback. Missing token.', 'INVALID_PAYPAL_TOKEN');
                    return;
                }

                console.log(`‚úÖ Processing payment: Order ${orderId}, Track ${trackId}, PayPal Token: ${paypalToken}`);

                // Capture the payment with proper error handling
                const apiBaseUrl = getApiBaseUrl();
                const captureUrl = `${apiBaseUrl}/api/payments/capture-order/${orderId}`;

                console.log(`üì° Calling: ${captureUrl}`);

                const response = await fetch(captureUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwt}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        track_id: trackId,
                        paypal_token: paypalToken,
                        payer_id: paypalPayerId
                    }),
                    timeout: 30000 // 30 second timeout
                });

                // FIX #4: Better error response handling
                let result;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        throw new Error(`Invalid response type: ${contentType}`);
                    }
                } catch (parseErr) {
                    console.error('Failed to parse response:', parseErr);
                    showError(`Server error: Invalid response format (${response.status})`, 'PARSE_ERROR');
                    return;
                }

                if (!response.ok) {
                    console.error('‚ùå Payment capture failed:', result);
                    showError(
                        `Payment failed: ${result.error || result.message || 'Unknown error'}`,
                        result.code || 'CAPTURE_FAILED'
                    );
                    return;
                }

                if (response.ok && (result.status === 'COMPLETED' || result.status === 'APPROVED')) {
                    console.log('‚úÖ Payment captured successfully:', result);

                    // Fetch track details
                    await fetchTrackDetails(trackId, jwt);

                    // Clear localStorage
                    localStorage.removeItem('pendingPaymentOrderId');
                    localStorage.removeItem('pendingTrackId');

                    // Mark as processed
                    paymentProcessed = true;

                    // Show success with delay so user sees spinner for a moment
                    setTimeout(() => {
                        showSuccess(result);
                    }, 800);
                } else {
                    showError(
                        `Unexpected status: ${result.status}`,
                        'UNEXPECTED_STATUS'
                    );
                }
            } catch (err) {
                console.error('‚ùå Error processing payment:', err);
                showError(
                    `Network error: ${err.message}. Please refresh to retry.`,
                    'NETWORK_ERROR'
                );
            }
        }

        async function fetchTrackDetails(trackId, jwt) {
            try {
                const apiBaseUrl = getApiBaseUrl();
                const trackUrl = `${apiBaseUrl}/api/tracks/${trackId}`;

                console.log(`üì° Fetching track details: ${trackUrl}`);

                const response = await fetch(trackUrl, {
                    headers: { 'Authorization': `Bearer ${jwt}` }
                });

                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        purchasedTrackData = await response.json();
                        console.log('‚úÖ Track details fetched:', purchasedTrackData);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Failed to fetch track details: ${response.status}`);
                }
            } catch (err) {
                console.error('‚ùå Error fetching track details:', err);
                // Don't fail the whole process if track details fail
            }
        }

        function showSuccess(paymentData) {
            const statusContainer = document.getElementById('statusContainer');
            const trackInfo = document.getElementById('trackInfo');
            const downloadBtn = document.getElementById('downloadBtn');
            const errorContainer = document.getElementById('errorContainer');

            statusContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            trackInfo.style.display = 'block';
            downloadBtn.style.display = 'block';

            // Populate track info
            if (purchasedTrackData) {
                document.getElementById('trackName').textContent = purchasedTrackData.name || 'Unknown';
                document.getElementById('trackArtist').textContent = purchasedTrackData.artist || 'Unknown';
                document.getElementById('trackPrice').textContent = paymentData.amount ? `‚Ç¨${(paymentData.amount / 100).toFixed(2)}` : '‚Ç¨0.99';
            }

            document.getElementById('purchaseDate').textContent = new Date().toLocaleDateString('de-DE');
            document.getElementById('transactionId').textContent = paymentData.transaction_id || paymentData.id || 'N/A';

            document.getElementById('successMessage').innerHTML = `
                <strong>üéâ Herzlichen Gl√ºckwunsch!</strong><br>
                Dein Track ist jetzt freigeschaltet und kann beliebig oft heruntergeladen und gestreamt werden.
            `;
        }

        function showError(message, errorCode = 'UNKNOWN') {
            const statusContainer = document.getElementById('statusContainer');
            const errorContainer = document.getElementById('errorContainer');
            const trackInfo = document.getElementById('trackInfo');

            statusContainer.style.display = 'none';
            trackInfo.style.display = 'none';
            errorContainer.style.display = 'block';

            document.getElementById('errorMessage').innerHTML = `
                <strong>‚ùå ${message}</strong><br>
                <small style="color: var(--text-secondary); margin-top: 8px; display: block;">
                    Error Code: ${errorCode}
                </small>
            `;

            // Disable navigation buttons to prevent further issues
            disableButtons();
        }

        function disableButtons() {
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('libraryBtn').disabled = true;
            document.getElementById('homeBtn').disabled = true;
        }

        function enableButtons() {
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('libraryBtn').disabled = false;
            document.getElementById('homeBtn').disabled = false;
        }

        // FIX #5: Better download with authentication
        function downloadTrack() {
            if (!purchasedTrackData) {
                alert('Track information not available. Please refresh the page.');
                return;
            }

            if (!purchasedTrackData.audio_filename && !purchasedTrackData.audio_url) {
                alert('Download link not available for this track.');
                return;
            }

            try {
                const apiBaseUrl = getApiBaseUrl();
                const jwt = localStorage.getItem('token');

                // Use authenticated download endpoint
                const downloadLink = purchasedTrackData.audio_url ||
                    `${apiBaseUrl}/api/tracks/audio/${purchasedTrackData.audio_filename}?token=${jwt}`;

                console.log('üì• Downloading track...');

                const a = document.createElement('a');
                a.href = downloadLink;
                a.download = `${purchasedTrackData.name || 'track'}.mp3`;
                a.setAttribute('target', '_blank');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (err) {
                console.error('Download error:', err);
                alert('Failed to download track. Please try again.');
            }
        }

        function goToLibrary() {
            const baseUrl = getBaseUrl();
            window.location.href = `${baseUrl}/index.html#/library`;
        }

        function goHome() {
            const baseUrl = getBaseUrl();
            window.location.href = `${baseUrl}/index.html`;
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('nexus-theme', newTheme);
        }

        // FIX #6: Better initialization with error recovery
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('nexus-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // Add retry button if needed
            console.log('üîÑ Initializing payment success page...');
            initializePaymentSuccess();
        });

        // Add global error handler
        window.addEventListener('error', (event) => {
            console.error('Uncaught error:', event.error);
            if (!paymentProcessed) {
                showError('An unexpected error occurred. Please refresh and try again.', 'UNCAUGHT_ERROR');
            }
        });
    </script>
</body>

</html>