require('dotenv').config();
const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const compression = require('compression');
const morgan = require('morgan');
const fs = require('fs');
const path = require('path');
const rfs = require('rotating-file-stream');
const cookieParser = require('cookie-parser');
const csrf = require('csurf');
const rateLimit = require('express-rate-limit');
const mongoSanitize = require('mongo-sanitize');
const xss = require('xss-clean');

const app = express();

// ============================================================================
// ðŸŽ¯ VALIDATE ENVIRONMENT VARIABLES
// ============================================================================

const requiredEnvVars = [
    'NODE_ENV',
    'PORT',
    'ALLOWED_ORIGINS',
    'JWT_SECRET',
    'DB_HOST',
    'DB_USER',
    'DB_PASSWORD',
];

const missingEnvVars = requiredEnvVars.filter(envVar => !process.env[envVar]);

if (missingEnvVars.length > 0) {
    console.error('âŒ FEHLER: Folgende Environment Variables fehlen:');
    missingEnvVars.forEach(envVar => console.error(`   - ${envVar}`));
    console.error('\nðŸ“ Bitte .env Datei Ã¼berprÃ¼fen!');
    process.exit(1);
}

console.log('âœ… Alle Environment Variables vorhanden!');

// ============================================================================
// ðŸ›¡ï¸ SECURITY MIDDLEWARE - ORDER MATTERS!
// ============================================================================

// 1ï¸âƒ£ Compression FIRST
app.use(compression());

// 2ï¸âƒ£ Helmet: HTTP security headers
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: ["'self'", "'unsafe-inline'"],
            styleSrc: ["'self'", "'unsafe-inline'"],
            mediaSrc: ["'self'", "http://localhost:*"],
            imgSrc: ["'self'", "data:", "https:"],
            connectSrc: ["'self'", "http://localhost:*", "api.paypal.com", "api.sandbox.paypal.com"],
        },
    },
    hsts: {
        maxAge: parseInt(process.env.HSTS_MAX_AGE || 31536000),
        includeSubDomains: true,
        preload: false,
    },
    noSniff: true,
    xssFilter: true,
}));

// 3ï¸âƒ£ CORS Configuration
app.use(cors({
    origin: [
        'http://localhost:5500',
        'http://127.0.0.1:5500',
        'http://localhost:3000'
    ],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: [
        'Content-Type',
        'Authorization',
        'X-Requested-With',
        'Accept',
        'Origin',
        'X-CSRF-Token'
    ],
    exposedHeaders: ['Content-Type', 'X-Total-Count', 'X-CSRF-Token'],
    optionsSuccessStatus: 200,
    maxAge: 86400
}));

// 4ï¸âƒ£ Body parser - WICHTIG VOR MULTER!
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));

// 5ï¸âƒ£ Cookie Parser BEFORE CSRF
app.use(cookieParser(process.env.COOKIE_SECRET || 'default-secret'));

// 6ï¸âƒ£ Input Sanitization
app.use(mongoSanitize());  // NoSQL Injection Protection
app.use(xss());            // XSS Protection

// 7ï¸âƒ£ CSRF Protection
const csrfProtection = csrf({
    cookie: {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'strict',
    },
});

app.use(csrfProtection);

// 8ï¸âƒ£ CSRF Token fÃ¼r Frontend
app.use((req, res, next) => {
    res.locals.csrfToken = req.csrfToken();
    res.setHeader('X-CSRF-Token', req.csrfToken());
    next();
});

// ============================================================================
// ðŸ“Š LOGGING SETUP WITH ROTATION
// ============================================================================

// Stelle sicher, dass logs/ Verzeichnis existiert
const logsDir = path.join(__dirname, 'logs');
if (!fs.existsSync(logsDir)) {
    fs.mkdirSync(logsDir, { recursive: true });
}

// âœ… Log Rotation Stream
const rotatingLogStream = rfs.createStream('app.log', {
    interval: '1d',           // TÃ¤glich rotieren
    path: logsDir,            // Pfad zu logs/
    maxSize: '10M',           // Max 10MB pro Datei
    maxFiles: 5,              // Max 5 alte Dateien behalten
    compress: 'gzip'          // Alte Logs komprimieren
});

// Morgan mit rotierenden Logs
app.use(morgan(':remote-addr - :remote-user [:date[clf]] ":method :url HTTP/:http-version" :status :res[content-length] - :response-time ms', { stream: rotatingLogStream }));

// Dev-Logging in Console
if (process.env.NODE_ENV !== 'production') {
    app.use(morgan('dev'));
}

console.log('âœ… Log rotation enabled: max 10MB per file, 5 files retained');

// ============================================================================
// â±ï¸ RATE LIMITING
// ============================================================================

// Auth Endpoints: SEHR strikt
const authLimiter = rateLimit({
    windowMs: parseInt(process.env.RATE_LIMIT_AUTH_WINDOW_MS || 900000),  // 15 min
    max: parseInt(process.env.RATE_LIMIT_AUTH_MAX || 5),                   // 5 attempts
    message: 'Zu viele Login-Versuche. Bitte spÃ¤ter erneut versuchen.',
    standardHeaders: true,
    legacyHeaders: false,
    skip: (req) => req.user && req.user.role === 'admin',
});

// API Endpoints: moderat
const apiLimiter = rateLimit({
    windowMs: parseInt(process.env.RATE_LIMIT_API_WINDOW_MS || 60000),  // 1 min
    max: parseInt(process.env.RATE_LIMIT_API_MAX || 30),                // 30 requests
    message: 'Zu viele Anfragen. Bitte langsamer machen.',
    standardHeaders: true,
    legacyHeaders: false,
    keyGenerator: (req) => {
        return req.user?.id || req.ip;
    },
});

// Audio Streaming: groÃŸzÃ¼gig
const streamLimiter = rateLimit({
    windowMs: parseInt(process.env.RATE_LIMIT_STREAM_WINDOW_MS || 60000),  // 1 min
    max: parseInt(process.env.RATE_LIMIT_STREAM_MAX || 50),                // 50 requests
    skip: (req) => {
        return req.headers['x-forwarded-for']?.includes('cache');
    },
});

console.log('âœ… Rate limiting configured');

// ============================================================================
// ðŸ“¦ DATABASE CONNECTION
// ============================================================================

const { Pool } = require('pg');

const pool = new Pool({
    host: process.env.DB_HOST,
    port: process.env.DB_PORT || 5432,
    database: process.env.DB_NAME || 'song_nexus_dev',
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
});

pool.on('error', (err) => {
    console.error('âŒ Database connection error:', err);
});

pool.on('connect', () => {
    console.log('âœ… Database connected');
});

module.exports.pool = pool;

// ============================================================================
// ðŸ”Œ STANDARD API ROUTES
// ============================================================================

console.log('ðŸ”§ Registering API routes...');

// Auth Routes mit STRICT Rate Limiting
app.use('/api/auth', authLimiter, require('./routes/auth'));

// API Routes mit MODERATE Rate Limiting
app.use('/api/', apiLimiter);

app.use('/api/payments', require('./routes/payments'));
app.use('/api/tracks', require('./routes/tracks'));
app.use('/api/users', require('./routes/users'));
app.use('/api/play-history', require('./routes/play-history'));
app.use('/api/admin/tracks', require('./routes/admin-tracks'));

console.log('âœ… API routes registered');

// ============================================================================
// ðŸŽµ DIRECT AUDIO STREAMING (Static Files mit CORS)
// ============================================================================

app.use('/public/audio', streamLimiter, (req, res, next) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, HEAD, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Range, Content-Type');
    res.setHeader('Accept-Ranges', 'bytes');
    res.setHeader('Cache-Control', 'public, max-age=86400');
    next();
});

app.use('/public/audio', express.static(path.join(__dirname, 'public/audio')));

// ============================================================================
// ðŸ› ERROR HANDLING
// ============================================================================

// CSRF Error Handler
app.use((err, req, res, next) => {
    if (err.code === 'EBADCSRFTOKEN') {
        console.error('âŒ CSRF Token validation failed');
        return res.status(403).json({
            error: 'CSRF Token validation failed',
        });
    }

    // Rate Limit Error Handler
    if (err.status === 429) {
        console.error('â±ï¸ Rate limit exceeded:', req.ip);
        return res.status(429).json({
            error: 'Zu viele Anfragen. Bitte warten.',
            retryAfter: err.retryAfter,
        });
    }

    // Standard Error Handler
    console.error('âŒ Error:', err.message);
    res.status(err.status || 500).json({
        error: process.env.NODE_ENV === 'development' ? err.message : 'Internal Server Error',
        ...(process.env.NODE_ENV === 'development' && { stack: err.stack }),
    });
});

// ============================================================================
// ðŸš€ START SERVER
// ============================================================================

const PORT = process.env.PORT || 3000;
const HOST = process.env.HOST || 'localhost';

const server = app.listen(PORT, HOST, () => {
    console.log('');
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘   ðŸŽµ SONG-NEXUS v6.0 Backend Start   â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`âœ… Server running on http://${HOST}:${PORT}`);
    console.log(`ðŸ”’ Environment: ${process.env.NODE_ENV}`);
    console.log(`ðŸ›¡ï¸ Security: Helmet + CSRF + Rate Limiting`);
    console.log(`ðŸ“ CORS Origins: ${process.env.ALLOWED_ORIGINS}`);
    console.log(`ðŸ“ Audio Path: ${path.join(__dirname, 'public/audio')}`);
    console.log(`ðŸ“Š Database: ${process.env.DB_HOST}:${process.env.DB_PORT || 5432}/${process.env.DB_NAME || 'song_nexus_dev'}`);
    console.log(`ðŸ“ Logs: ${logsDir} (rotation: 10MB max, 5 files, daily)`);
    console.log('');
});

// Graceful Shutdown
process.on('SIGTERM', () => {
    console.log('ðŸ“‹ SIGTERM received, shutting down gracefully...');
    server.close(() => {
        console.log('âœ… Server closed');
        pool.end();
        process.exit(0);
    });
});

module.exports = app;
module.exports.pool = pool;