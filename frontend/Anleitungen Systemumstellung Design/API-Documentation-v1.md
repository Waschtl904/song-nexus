# üéµ SONG-NEXUS API Documentation v1.0
**Complete REST API Reference - Backend Routes**

---

## üìä API Overview

| Base URL | Port | Protocol |
|----------|------|----------|
| `https://localhost:3000` | 3000 | HTTPS (mkcert) |
| `/api` | ‚Äî | All routes prefixed with `/api` |

---

## üîê Authentication

All endpoints (except public ones) require a **JWT Bearer Token** in the `Authorization` header:

```
Authorization: Bearer <JWT_TOKEN>
```

**Token Format:**
- Generated by: `/api/auth/login` or `/api/auth/register`
- Expiry: 7 days (configurable via `JWT_EXPIRE`)
- Secret: `JWT_SECRET` from `.env`

---

## üìö ENDPOINTS BY CATEGORY

---

## 1Ô∏è‚É£ AUTHENTICATION ROUTES (`/api/auth`)

### POST /register
**Register new user with email & password**

**Auth:** None (Public)

**Request Body:**
```json
{
  "email": "user@example.com",
  "username": "johnsmith",
  "password": "SecurePassword123!"
}
```

**Validation:**
- Email: Must be valid email format
- Username: 3-20 characters
- Password: Minimum 8 characters

**Response (201):**
```json
{
  "message": "User registered successfully",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "username": "johnsmith",
    "role": "user"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

### POST /login
**Login with username/email + password**

**Auth:** None (Public)

**Request Body:**
```json
{
  "username": "johnsmith",
  "password": "SecurePassword123!"
}
```

*Note: `username` field accepts both username AND email*

**Response (200):**
```json
{
  "message": "Login successful",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "username": "johnsmith",
    "role": "user"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Error (401):**
```json
{
  "error": "Invalid credentials"
}
```

---

### POST /dev-login
**Quick development login (creates dev user if needed)**

**Auth:** None (Public)

**Request Body:** Empty

**Credentials:** 
- Email: `dev@localhost`
- Username: `devuser`
- Password: `dev123456`
- Role: `admin` (auto-created)

**Response (200):**
```json
{
  "success": true,
  "message": "‚úÖ Dev login successful",
  "user": {...},
  "token": "..."
}
```

---

### POST /verify
**Verify JWT token is valid**

**Auth:** Required ‚úÖ

**Request Body:** Empty

**Response (200):**
```json
{
  "valid": true,
  "user": {
    "id": 1,
    "email": "user@example.com",
    "username": "johnsmith"
  }
}
```

---

### GET /me
**Get current authenticated user profile**

**Auth:** Required ‚úÖ

**Response (200):**
```json
{
  "user": {
    "id": 1,
    "email": "user@example.com",
    "username": "johnsmith",
    "role": "user",
    "created_at": "2025-12-19T10:00:00Z",
    "is_active": true
  }
}
```

---

### POST /refresh-token
**Generate new JWT token (refresh existing token)**

**Auth:** Required ‚úÖ

**Response (200):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

### POST /logout
**Logout (client-side token removal)**

**Auth:** Required ‚úÖ

**Response (200):**
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

*Note: Stateless - token is removed on frontend*

---

## 2Ô∏è‚É£ WEBAUTHN BIOMETRIC ROUTES (`/api/auth/webauthn`)

### POST /register-options
**Generate WebAuthn registration options (for biometric signup)**

**Auth:** None (Public)

**Request Body:**
```json
{
  "username": "johnsmith",
  "email": "user@example.com"
}
```

**Response (200):**
```json
{
  "challenge": "base64url-encoded-challenge",
  "rp": {
    "name": "SONG-NEXUS",
    "id": "localhost"
  },
  "user": {
    "id": "base64url-encoded-userid",
    "name": "johnsmith",
    "displayName": "user@example.com"
  },
  "pubKeyCredParams": [...]
}
```

*Sets session cookie for challenge verification*

---

### POST /register-verify
**Verify biometric registration response**

**Auth:** None (Public)

**Request Body:**
```json
{
  "id": "credential-id",
  "rawId": "base64url",
  "response": {
    "clientDataJSON": "base64url",
    "attestationObject": "base64url"
  },
  "type": "public-key"
}
```

**Response (200):**
```json
{
  "verified": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "username": "johnsmith",
    "email": "user@example.com"
  }
}
```

---

### POST /authenticate-options
**Generate WebAuthn authentication options (for biometric login)**

**Auth:** None (Public)

**Response (200):**
```json
{
  "challenge": "base64url-encoded-challenge",
  "timeout": 60000,
  "allowCredentials": [
    {
      "id": "credential-id",
      "type": "public-key",
      "transports": ["internal"]
    }
  ]
}
```

---

### POST /authenticate-verify
**Verify biometric authentication response**

**Auth:** None (Public)

**Request Body:** WebAuthn assertion response

**Response (200):**
```json
{
  "verified": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "username": "johnsmith",
    "email": "user@example.com"
  }
}
```

---

### POST /register-password
**Register with password (alternative to biometric)**

**Auth:** None (Public)

**Request Body:**
```json
{
  "username": "johnsmith",
  "email": "user@example.com",
  "password": "SecurePassword123!",
  "passwordConfirm": "SecurePassword123!"
}
```

**Validation:**
- Password: Minimum 8 characters
- Passwords: Must match
- Email: Valid format

**Response (201):**
```json
{
  "verified": true,
  "token": "...",
  "user": {...}
}
```

---

## 3Ô∏è‚É£ TRACKS ROUTES (`/api/tracks`)

### GET /
**Get all published tracks (paginated)**

**Auth:** None (Public)

**Query Parameters:**
```
GET /api/tracks?page=1&limit=12&search=test&genre=Rock&sort=created_at
```

| Parameter | Type | Default | Max | Notes |
|-----------|------|---------|-----|-------|
| `page` | int | 1 | ‚Äî | Page number |
| `limit` | int | 12 | 100 | Items per page |
| `search` | string | ‚Äî | ‚Äî | Search by name or artist |
| `genre` | string | ‚Äî | ‚Äî | Filter by genre (exact match) |
| `sort` | string | created_at | ‚Äî | created_at, play_count, name, artist |

**Response (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Song Name",
      "artist": "Artist Name",
      "genre": "Rock",
      "description": "Track description",
      "price_eur": 0.99,
      "duration_seconds": 240,
      "play_count": 150,
      "audio_filename": "timestamp-userid-name.mp3",
      "is_free": false,
      "free_preview_duration": 40,
      "created_at": "2025-12-19T10:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 12,
    "total": 45,
    "totalPages": 4,
    "hasNextPage": true,
    "hasPrevPage": false,
    "hasMore": true
  },
  "metadata": {
    "timestamp": "2025-12-19T14:30:00Z",
    "search": "test",
    "genre": "Rock",
    "sort": "created_at DESC"
  }
}
```

---

### GET /audio/:filename
**Stream audio file (with preview/full access control)**

**Auth:** None (Public, but full file requires purchase)

**Parameters:**
```
GET /api/tracks/audio/1703011200-1-song-name.mp3
```

**Response Headers:**
```
Accept-Ranges: bytes
Content-Type: audio/mpeg
Content-Length: 5242880
Cache-Control: public, max-age=86400
```

**Logic:**
- **FREE Track** (is_free=true) ‚Üí Full file access for everyone
- **PAID Track** (is_free=false) ‚Üí 40-second preview OR full file if purchased
- **Without Token** ‚Üí 40-second preview
- **With Valid Token + Purchase** ‚Üí Full file

**Response:**
- **206 Partial Content:** Range request (streaming)
- **200 OK:** Full file
- **404 Not Found:** Audio file not found

---

### GET /:id
**Get single track details**

**Auth:** None (Public)

**Parameters:**
```
GET /api/tracks/1
```

**Response (200):**
```json
{
  "id": 1,
  "name": "Song Name",
  "artist": "Artist Name",
  "genre": "Rock",
  "description": "Full description",
  "price_eur": 0.99,
  "play_count": 150,
  "duration_seconds": 240,
  "audio_filename": "timestamp-userid-name.mp3",
  "is_published": true,
  "is_free": false,
  "free_preview_duration": 40,
  "created_at": "2025-12-19T10:00:00Z"
}
```

---

### GET /genres/list
**Get all available genres**

**Auth:** None (Public)

**Response (200):**
```json
[
  "Rock",
  "Electronic",
  "Jazz",
  "Pop",
  "Classical"
]
```

---

## 4Ô∏è‚É£ ADMIN TRACKS ROUTES (`/api/admin/tracks`)

### POST /upload
**Upload new track (Admin only)**

**Auth:** Required ‚úÖ + Admin Role

**Request Body:** FormData (multipart/form-data)
```
name: "Song Name" (required)
artist: "Artist Name" (required)
duration_seconds: 240 (required, integer)
genre: "Rock" (optional)
price_eur: 0.99 (required, float)
is_free: true/false (optional, boolean)
is_published: true/false (optional, boolean)
audio: <File> (required, MP3/WAV, max 100MB)
```

**Response (201):**
```json
{
  "success": true,
  "message": "Track erfolgreich hochgeladen!",
  "track": {
    "id": 1,
    "name": "Song Name",
    "artist": "Artist Name",
    "price_eur": 0.99,
    "is_free": false,
    "filename": "timestamp-userid-name.mp3",
    "duration_seconds": 240
  }
}
```

---

### GET /list
**List all tracks (Admin only)**

**Auth:** Required ‚úÖ + Admin Role

**Response (200):**
```json
[
  {
    "id": 1,
    "name": "Song Name",
    "artist": "Artist Name",
    "duration_seconds": 240,
    "genre": "Rock",
    "price_eur": 0.99,
    "is_free": false,
    "audio_filename": "timestamp-userid-name.mp3",
    "is_published": true,
    "play_count": 150,
    "file_size_bytes": 5242880,
    "created_at": "2025-12-19T10:00:00Z"
  }
]
```

---

### PUT /:id
**Update track metadata (Admin only)**

**Auth:** Required ‚úÖ + Admin Role

**Request Body:**
```json
{
  "name": "Updated Song Name",
  "artist": "Updated Artist",
  "price_eur": 1.99,
  "genre": "Pop",
  "is_free": false,
  "is_published": true
}
```

*All fields optional - only provided fields updated*

**Response (200):**
```json
{
  "success": true,
  "message": "Track aktualisiert!",
  "track": {
    "id": 1,
    "name": "Updated Song Name",
    "artist": "Updated Artist",
    "price_eur": 1.99,
    "genre": "Pop",
    "is_published": true,
    "is_free": false
  }
}
```

---

### DELETE /:id
**Soft delete track (Admin only)**

**Auth:** Required ‚úÖ + Admin Role

**Response (200):**
```json
{
  "success": true,
  "message": "Track gel√∂scht!",
  "track": {
    "id": 1,
    "name": "Song Name"
  },
  "note": "Die Audiodatei wurde NICHT gel√∂scht und bleibt auf dem Server."
}
```

*Soft delete: is_deleted=true, file stays on disk*

---

## 5Ô∏è‚É£ PAYMENTS ROUTES (`/api/payments`)

### GET /config
**Get PayPal configuration (for frontend)**

**Auth:** None (Public)

**Response (200):**
```json
{
  "paypal_client_id": "AVcWZuGRhdUJABGqLs6JhfMuPO_ZTKLP6SK5yU3out-Sfvbq...",
  "paypal_mode": "sandbox"
}
```

---

### POST /create-order
**Create PayPal order for track purchase**

**Auth:** Required ‚úÖ

**Request Body:**
```json
{
  "track_id": 1,
  "price": 0.99
}
```

**Response (200):**
```json
{
  "order_id": "7GL6XXXXXXXXXXXX",
  "status": "CREATED",
  "track_id": 1,
  "price": 0.99
}
```

---

### POST /capture-order/:orderId
**Capture PayPal payment (finalize purchase)**

**Auth:** Required ‚úÖ

**Parameters:**
```
POST /api/payments/capture-order/7GL6XXXXXXXXXXXX
```

**Request Body:**
```json
{
  "track_id": 1
}
```

**Response (200):**
```json
{
  "status": "COMPLETED",
  "message": "Payment successful - Track unlocked!",
  "transaction_id": "6UU82XXXXXXXXXXXX",
  "track_id": 1
}
```

---

### GET /user-purchases
**Get user's purchased tracks**

**Auth:** Required ‚úÖ

**Response (200):**
```json
[
  {
    "id": 1,
    "track_id": 1,
    "name": "Song Name",
    "artist": "Artist Name",
    "audio_filename": "timestamp-userid-name.mp3",
    "purchased_at": "2025-12-19T12:00:00Z",
    "license_type": "personal",
    "order_id": 1
  }
]
```

---

### GET /history
**Get payment order history**

**Auth:** Required ‚úÖ

**Response (200):**
```json
[
  {
    "id": 1,
    "paypal_order_id": "7GL6XXXXXXXXXXXX",
    "amount": 0.99,
    "currency": "EUR",
    "status": "COMPLETED",
    "created_at": "2025-12-19T12:00:00Z",
    "completed_at": "2025-12-19T12:01:00Z",
    "description": "Track: Song Name",
    "transaction_id": "6UU82XXXXXXXXXXXX"
  }
]
```

---

### GET /stats
**Get payment statistics**

**Auth:** Required ‚úÖ

**Response (200):**
```json
{
  "completed_payments": 5,
  "failed_payments": 0,
  "total_spent": "4.95",
  "avg_purchase": 0.99,
  "total_tracks_purchased": 5
}
```

---

## 6Ô∏è‚É£ USERS ROUTES (`/api/users`)

### GET /profile
**Get user profile**

**Auth:** Required ‚úÖ

**Response (200):**
```json
{
  "id": 1,
  "email": "user@example.com",
  "username": "johnsmith",
  "role": "user",
  "created_at": "2025-12-19T10:00:00Z",
  "last_login": "2025-12-19T14:30:00Z",
  "is_active": true
}
```

---

### GET /stats
**Get user statistics (purchases, plays, spending)**

**Auth:** Required ‚úÖ

**Response (200):**
```json
{
  "id": 1,
  "username": "johnsmith",
  "total_purchases": 5,
  "total_plays": 127,
  "total_spent": "4.95",
  "last_purchase_date": "2025-12-19T12:00:00Z"
}
```

---

### GET /purchases
**Get user's purchased tracks**

**Auth:** Required ‚úÖ

**Response (200):**
```json
[
  {
    "id": 1,
    "track_id": 1,
    "name": "Song Name",
    "artist": "Artist Name",
    "genre": "Rock",
    "price_eur": 0.99,
    "audio_filename": "timestamp-userid-name.mp3",
    "purchased_at": "2025-12-19T12:00:00Z",
    "license_type": "personal"
  }
]
```

---

### GET /play-history
**Get user's play history**

**Auth:** Required ‚úÖ

**Query Parameters:**
```
GET /api/users/play-history?limit=50
```

**Response (200):**
```json
[
  {
    "id": 1,
    "track_id": 1,
    "name": "Song Name",
    "artist": "Artist Name",
    "genre": "Rock",
    "played_at": "2025-12-19T13:00:00Z",
    "duration_played_seconds": 240,
    "completed": true
  }
]
```

---

### GET /leaderboard
**Get top users (public)**

**Auth:** None (Public)

**Response (200):**
```json
[
  {
    "username": "johnsmith",
    "total_purchases": 15,
    "total_plays": 523
  },
  {
    "username": "alice",
    "total_purchases": 12,
    "total_plays": 412
  }
]
```

---

## 7Ô∏è‚É£ PLAY HISTORY ROUTES (`/api/play-history`)

### POST /
**Log a track play**

**Auth:** Required ‚úÖ

**Request Body:**
```json
{
  "track_id": 1,
  "duration_played_seconds": 240
}
```

**Response (201):**
```json
{
  "id": 1,
  "user_id": 1,
  "track_id": 1,
  "played_at": "2025-12-19T13:00:00Z",
  "duration_played_seconds": 240
}
```

---

### GET /user/:userId
**Get user's play history**

**Auth:** Required ‚úÖ (Users can see own data, admins see all)

**Parameters:**
```
GET /api/play-history/user/1?limit=50&offset=0
```

**Response (200):**
```json
[
  {
    "id": 1,
    "track_id": 1,
    "played_at": "2025-12-19T13:00:00Z",
    "duration_played_seconds": 240,
    "name": "Song Name",
    "artist": "Artist Name",
    "audio_filename": "timestamp-userid-name.mp3"
  }
]
```

---

### DELETE /user/:userId
**Clear user's play history**

**Auth:** Required ‚úÖ (Users can delete own, admins delete all)

**Response (200):**
```json
{
  "success": true,
  "message": "Play history cleared successfully",
  "deleted_count": 127
}
```

---

### GET /stats/user/:userId
**Get user's play statistics**

**Auth:** Required ‚úÖ (Users can see own, admins see all)

**Response (200):**
```json
{
  "total_plays": 127,
  "unique_tracks": 45,
  "total_seconds_played": 28800,
  "last_played": "2025-12-19T13:00:00Z",
  "first_played": "2025-12-15T10:00:00Z"
}
```

---

## üî¥ ERROR RESPONSES

**Format (All Errors):**
```json
{
  "error": "Error message",
  "details": "Optional detailed explanation (dev mode only)"
}
```

### Common Status Codes

| Code | Meaning | Example |
|------|---------|---------|
| 200 | OK | Successfully fetched resource |
| 201 | Created | Resource created (register, upload) |
| 206 | Partial Content | Range request (audio streaming) |
| 400 | Bad Request | Invalid input validation |
| 401 | Unauthorized | Missing/invalid token |
| 403 | Forbidden | Insufficient permissions |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Duplicate user/email |
| 413 | Payload Too Large | File exceeds max size |
| 429 | Rate Limit Exceeded | Too many requests |
| 500 | Server Error | Internal error |

---

## üîí Authorization

**Public Endpoints (No Token Required):**
- `GET /api/tracks` (list tracks)
- `GET /api/tracks/:id` (track details)
- `GET /api/tracks/audio/:filename` (audio with preview)
- `GET /api/tracks/genres/list` (genres list)
- `GET /api/users/leaderboard` (public leaderboard)
- `GET /api/payments/config` (PayPal config)
- `/api/auth/*` (registration, login, WebAuthn flows)

**Protected Endpoints (Token Required):**
- All other `/api/*` routes
- Verified via `Authorization: Bearer <token>`

**Admin-Only Endpoints:**
- `POST /api/admin/tracks/upload`
- `GET /api/admin/tracks/list`
- `PUT /api/admin/tracks/:id`
- `DELETE /api/admin/tracks/:id`

---

## üéØ Typical User Flows

### Flow 1: Register & Play Free Track
1. `POST /api/auth/register` (create account, get token)
2. `GET /api/tracks` (list all tracks)
3. `GET /api/tracks/audio/:filename` (stream 40s preview)
4. If free track: Continue streaming full file

### Flow 2: Purchase & Play Paid Track
1. (User logged in)
2. `POST /api/payments/create-order` (create PayPal order)
3. User completes PayPal checkout (external)
4. `POST /api/payments/capture-order/:orderId` (finalize payment)
5. `GET /api/tracks/audio/:filename` (stream full file)

### Flow 3: Biometric Registration
1. `POST /api/auth/webauthn/register-options` (get challenge)
2. User touches fingerprint/face
3. `POST /api/auth/webauthn/register-verify` (send response, get token)
4. Done! User registered with biometric

---

**Last Updated:** December 19, 2025  
**Version:** 1.0 (Complete)  
**Status:** ‚úÖ Ready for Development