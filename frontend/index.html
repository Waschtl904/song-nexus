<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ SONG-NEXUS v6.0 - Music Streaming Platform</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' fill='%2300cc77'>â™ª</text></svg>">

    <!-- ğŸ¨ DEINE ORIGINAL CYBERPUNK CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- ============================================================================
         HEADER
         ============================================================================ -->
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>â™ª SONG-NEXUS v6.0</h1>
                <p class="subtitle">WebAuthn + Magic Link Authentication | WCAG 2.2 Accessible</p>
            </div>
            <div id="userInfo" style="display: none; text-align: right; color: var(--accent-teal);">
                <p id="userDisplay" style="margin: 0; font-weight: bold;"></p>
                <button class="button button-secondary" onclick="App.logout()"
                    style="margin-top: 8px; padding: 4px 12px; font-size: 0.9rem;">ğŸ”“ Logout</button>
            </div>
        </div>
    </header>

    <!-- ============================================================================
         MAIN CONTENT
         ============================================================================ -->
    <div class="container">
        <!-- ====================================================================
             ğŸ” AUTHENTICATION SECTION
             ==================================================================== -->
        <section class="auth-section active" id="authSection">
            <h2>ğŸ” Authentication</h2>

            <!-- Auth Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('biometric', event)">ğŸ‘† Fingerprint</button>
                <button class="tab-btn" onclick="switchTab('magic-link', event)">ğŸ“§ Magic Link</button>
                <button class="tab-btn" onclick="switchTab('password', event)">ğŸ”‘ Password</button>
            </div>

            <!-- 1ï¸âƒ£ BIOMETRIC TAB (WebAuthn) -->
            <div id="biometric-tab" class="tab-content active">
                <div style="text-align: center; padding: 20px 0;">
                    <h2 style="color: var(--accent-teal); margin: 0 0 12px 0; font-size: 1.4rem;">ğŸ‘† Scan Your
                        Fingerprint</h2>
                    <p style="color: var(--text-secondary); margin: 0 0 20px 0; font-size: 0.9rem;">
                        Fast, secure, and accessible for everyone.<br />
                        <small>(No password to remember)</small>
                    </p>

                    <button class="button" onclick="biometricLogin()" style="margin: 10px auto; display: inline-block;">
                        ğŸ‘† Use Fingerprint / Face
                    </button>

                    <!-- ğŸ§ª Dev Login Button (nur fÃ¼r Development) -->
                    <button class="button button-secondary" onclick="WebAuthn.devLogin()"
                        style="margin: 10px auto; display: inline-block; opacity: 0.6;">
                        ğŸ§ª Dev Login
                    </button>

                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 16px;">
                        First time? <a href="#" onclick="toggleBioRegister(true); return false;"
                            style="color: var(--accent-teal); cursor: pointer;">Register with Fingerprint</a>
                    </p>

                    <!-- Biometric Register Modal -->
                    <div id="bioRegisterModal"
                        style="display: none; background: rgba(15, 21, 39, 0.9); border: 1px solid var(--accent-teal); border-radius: 6px; padding: 24px; margin-top: 20px;">
                        <h3 style="color: var(--accent-teal); margin-bottom: 16px;">ğŸ“ Register with Fingerprint</h3>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="bioRegUsername" placeholder="username">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="bioRegEmail" placeholder="your@email.com">
                        </div>
                        <button class="button" onclick="registerWithBiometric()">ğŸ“ Register</button>
                        <button class="button button-secondary" onclick="toggleBioRegister(false)">Cancel</button>
                        <div id="bioRegStatus" class="status-message"></div>
                    </div>

                    <div id="bioStatus" class="status-message"></div>
                </div>
            </div>

            <!-- 2ï¸âƒ£ MAGIC LINK TAB (Email) -->
            <div id="magic-link-tab" class="tab-content" style="padding: 20px;">
                <h3 style="color: var(--accent-teal); margin-bottom: 16px;">ğŸ“§ Magic Link</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">
                    We'll send you a secure login link via email.<br />
                    <small>(Perfect for accessibility)</small>
                </p>

                <div class="card">
                    <div class="form-group">
                        <label for="magicEmail">Email Address</label>
                        <input type="email" id="magicEmail" placeholder="your@email.com" required>
                    </div>
                    <button class="button" style="width: 100%;" onclick="sendMagicLink()">ğŸ“§ Send Login Link</button>
                    <div id="magicStatus" class="status-message" style="margin-top: 16px;"></div>
                </div>
            </div>

            <!-- 3ï¸âƒ£ PASSWORD TAB -->
            <div id="password-tab" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="card">
                        <h3 style="color: var(--accent-teal); margin-bottom: 16px;">ğŸ“ REGISTER</h3>
                        <form onsubmit="Auth.register(event)">
                            <div class="form-group">
                                <label for="regEmail">Email</label>
                                <input type="email" id="regEmail" placeholder="your@email.com" required>
                            </div>
                            <div class="form-group">
                                <label for="regUsername">Username</label>
                                <input type="text" id="regUsername" placeholder="username" required>
                            </div>
                            <div class="form-group">
                                <label for="regPassword">Password (min 8 chars)</label>
                                <input type="password" id="regPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                            </div>
                            <button type="submit" class="button" style="width: 100%;">ğŸ“ Register</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3 style="color: var(--accent-teal); margin-bottom: 16px;">ğŸ” LOGIN</h3>
                        <form onsubmit="Auth.login(event)">
                            <div class="form-group">
                                <label for="loginEmail">Email</label>
                                <input type="email" id="loginEmail" placeholder="your@email.com" required>
                            </div>
                            <div class="form-group">
                                <label for="loginPassword">Password</label>
                                <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                            </div>
                            <button type="submit" class="button" style="width: 100%;">ğŸ” Login</button>
                        </form>
                    </div>
                </div>
                <div class="status-message" id="authStatus"></div>
            </div>
        </section>

        <!-- ====================================================================
             ğŸµ TRACKS SECTION
             ==================================================================== -->
        <section>
            <h2>ğŸµ Available Tracks</h2>
            <div id="tracksList" class="track-grid">
                <div class="card" style="grid-column: 1/-1; text-align: center;">
                    <p style="color: var(--text-secondary);">ğŸµ Login to see available tracks</p>
                </div>
            </div>
        </section>

        <!-- ====================================================================
             ğŸ“Š PLAY HISTORY SECTION
             ==================================================================== -->
        <section>
            <h2>ğŸ“Š Your Play History</h2>
            <div id="historyList">
                <div class="card" style="text-align: center;">
                    <p style="color: var(--text-secondary);">ğŸ“Š Login to see your history</p>
                </div>
            </div>
        </section>
    </div>

    <!-- ============================================================================
         FOOTER
         ============================================================================ -->
    <footer>
        <p>ğŸµ SONG-NEXUS v6.0 | ğŸ” WebAuthn + Magic Link | â™¿ WCAG 2.2 Accessible</p>
        <p style="margin-top: 8px; font-size: 0.7rem;">
            Built with â¤ï¸ | Â© 2025 Sebastian's Full-Stack Platform
        </p>
    </footer>

    <!-- ============================================================================
         ğŸ” SCRIPTS - WICHTIG: REIHENFOLGE!
         ============================================================================ -->
    <script src="js/webauthn.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>

    <!-- ============================================================================
         UI HELPERS (inline)
         ============================================================================ -->
    <script>
        // ====================================================================
        // ğŸ¨ UPDATE UI BASED ON AUTH STATE
        // ====================================================================
        function updateUI() {
            const token = Auth.getToken();
            const user = Auth.getUser();
            const authSection = document.getElementById('authSection');
            const userInfo = document.getElementById('userInfo');
            const userDisplay = document.getElementById('userDisplay');

            if (token && user) {
                // ğŸ”“ LOGGED IN
                authSection.style.display = 'none';
                userInfo.style.display = 'block';
                userDisplay.textContent = `ğŸ‘¤ ${user.username}`;
                App.loadTracks();
                App.loadHistory();
            } else {
                // ğŸ” LOGGED OUT
                authSection.style.display = 'block';
                userInfo.style.display = 'none';
            }
        }

        // Tab Switching
        function switchTab(tabName, event) {
            if (event) {
                event.preventDefault();
                // Remove active from all tabs
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

                // Add active to selected
                document.getElementById(tabName + '-tab').classList.add('active');
                event.target.classList.add('active');
            }
        }

        // Biometric Register Modal
        function toggleBioRegister(show) {
            const modal = document.getElementById('bioRegisterModal');
            modal.style.display = show ? 'block' : 'none';
        }

        // Show Status Message
        function showStatus(elementId, message, type = 'success') {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // Biometric Login
        async function biometricLogin() {
            try {
                if (!window.WebAuthn) {
                    showStatus('bioStatus', 'âŒ WebAuthn not loaded', 'error');
                    return;
                }
                showStatus('bioStatus', 'ğŸ‘† Scanning fingerprint...', 'loading');
                const result = await WebAuthn.authenticateWithBiometric();
                Auth.setToken(result.token);
                Auth.setUser(result.user);
                showStatus('bioStatus', 'âœ… Login successful!', 'success');
                updateUI();
            } catch (error) {
                showStatus('bioStatus', `âŒ ${error.message}`, 'error');
            }
        }

        // Register with Biometric
        async function registerWithBiometric() {
            try {
                const username = document.getElementById('bioRegUsername')?.value.trim();
                const email = document.getElementById('bioRegEmail')?.value.trim();
                if (!username || !email) {
                    showStatus('bioRegStatus', 'âŒ Username and email required', 'error');
                    return;
                }
                showStatus('bioRegStatus', 'â³ Registering...', 'loading');
                const result = await WebAuthn.registerWithBiometric(username, email);
                Auth.setToken(result.token);
                Auth.setUser(result.user);
                showStatus('bioRegStatus', 'âœ… Registration successful!', 'success');
                document.getElementById('bioRegUsername').value = '';
                document.getElementById('bioRegEmail').value = '';
                updateUI();
            } catch (error) {
                showStatus('bioRegStatus', `âŒ ${error.message}`, 'error');
            }
        }

        // Magic Link
        async function sendMagicLink() {
            try {
                const email = document.getElementById('magicEmail')?.value.trim();
                if (!email) {
                    showStatus('magicStatus', 'âŒ Email required', 'error');
                    return;
                }
                showStatus('magicStatus', 'â³ Sending link...', 'loading');
                await WebAuthn.loginWithMagicLink(email);
                showStatus('magicStatus', 'âœ… Check your email for login link!', 'success');
                document.getElementById('magicEmail').value = '';
            } catch (error) {
                showStatus('magicStatus', `âŒ ${error.message}`, 'error');
            }
        }

        // ====================================================================
        // ğŸ¯ CHECK AUTH STATUS ON PAGE LOAD
        // ====================================================================
        window.addEventListener('load', () => {
            console.log('âš¡ SONG-NEXUS v6.0 LOADED âš¡');
            console.log('âœ… JWT Auth | âœ… CSRF Protected | âœ… Accessible | âœ… Reset History');

            const token = Auth.getToken();
            if (token) {
                const user = Auth.getUser();
                console.log(`âœ… Logged in as: ${user?.username || 'User'}`);
            }
            console.log('âœ… App ready');

            // âœ¨ UPDATE UI ON LOAD
            updateUI();
        });
        // ============================================================================
        // DEMO AUTH - Funktioniert OHNE Backend (fÃ¼r schnelle Tests)
        // ============================================================================
        // Kopiere diesen Code in deine auth-styled.html <script> section
        // oder nutze ihn um dein Backend zu debuggen

        const DEMO_MODE = true; // DEMO_MODE fÃ¼r schnelle Tests ohne Backend

        // DEMO USERS (fÃ¼r lokale Tests)
        const DEMO_USERS = {
            'admin@test.local': {
                username: 'Admin',
                email: 'admin@test.local',
                password: 'password123',
                id: 1
            },
            'user@test.local': {
                username: 'TestUser',
                email: 'user@test.local',
                password: 'password123',
                id: 2
            }
        };

        // ============================================================================
        // ERWEITERTE LOGIN FUNKTION MIT FALLBACK
        // ============================================================================

        async function handleLoginWithFallback() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('loginMsg', 'âŒ Alle Felder ausfÃ¼llen!', 'error');
                return;
            }

            setLoading('login', true);

            try {
                // 1. ZUERST: Versuche echten Backend-Login
                console.log('ğŸ“¡ Versuche Backend Login...');
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                    signal: AbortSignal.timeout(3000) // 3 Sekunden Timeout
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showMessage('loginMsg', 'âœ… Backend Login erfolgreich!', 'success');
                    setTimeout(() => location.href = '/app.html', 1000);
                    return;
                }

                throw new Error('Backend nicht erreichbar');

            } catch (backendError) {
                console.warn('âš ï¸ Backend Login fehlgeschlagen:', backendError.message);

                // 2. FALLBACK: Demo-Mode wenn Backend nicht lÃ¤uft
                if (DEMO_MODE) {
                    console.log('ğŸ“ Nutze Demo-Mode...');
                    const user = DEMO_USERS[email];

                    if (!user || user.password !== password) {
                        showMessage('loginMsg', 'âŒ Email oder Passwort falsch!\nğŸ’¡ Demo-User: admin@test.local / password123', 'error');
                        setLoading('login', false);
                        return;
                    }

                    // Demo-Token erstellen
                    const token = `demo_token_${user.id}_${Date.now()}`;
                    localStorage.setItem('auth_token', token);
                    localStorage.setItem('user', JSON.stringify({
                        id: user.id,
                        username: user.username,
                        email: user.email,
                        isDemoUser: true
                    }));

                    showMessage('loginMsg', 'âœ… Demo-Mode: Login erfolgreich!', 'success');
                    setTimeout(() => location.href = '/app.html', 1000);
                    return;
                }

                showMessage('loginMsg', 'âŒ Backend nicht erreichbar!\nğŸ’¡ Starten Sie den Server: npm start', 'error');
                setLoading('login', false);
            }
        }

        // ============================================================================
        // ERWEITERTE REGISTER FUNKTION MIT FALLBACK
        // ============================================================================

        async function handleRegisterWithFallback() {
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;

            if (!username || !email || !password) {
                showMessage('registerMsg', 'âŒ Alle Felder ausfÃ¼llen!', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showMessage('registerMsg', 'âŒ PasswÃ¶rter stimmen nicht Ã¼berein!', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('registerMsg', 'âŒ Passwort mindestens 6 Zeichen!', 'error');
                return;
            }

            setLoading('register', true);

            try {
                // 1. ZUERST: Versuche echten Backend-Register
                console.log('ğŸ“¡ Versuche Backend Register...');
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password }),
                    signal: AbortSignal.timeout(3000)
                });

                if (response.ok) {
                    showMessage('registerMsg', 'âœ… Registrierung erfolgreich!', 'success');
                    setTimeout(() => {
                        toggleForm('login');
                        document.getElementById('loginEmail').value = email;
                        setLoading('register', false);
                    }, 1500);
                    return;
                }

                throw new Error('Backend nicht erreichbar');

            } catch (backendError) {
                console.warn('âš ï¸ Backend Register fehlgeschlagen:', backendError.message);

                // 2. FALLBACK: Demo-Mode wenn Backend nicht lÃ¤uft
                if (DEMO_MODE) {
                    console.log('ğŸ“ Nutze Demo-Mode fÃ¼r Registrierung...');

                    // Speichere neuen User in localStorage fÃ¼r Demo
                    const newUser = {
                        username,
                        email,
                        password,
                        id: Math.floor(Math.random() * 10000)
                    };
                    localStorage.setItem(`demo_user_${email}`, JSON.stringify(newUser));

                    showMessage('registerMsg', 'âœ… Demo-Registrierung erfolgreich!', 'success');
                    setTimeout(() => {
                        toggleForm('login');
                        document.getElementById('loginEmail').value = email;
                        document.getElementById('loginPassword').value = password;
                        setLoading('register', false);
                    }, 1500);
                    return;
                }

                showMessage('registerMsg', 'âŒ Backend nicht erreichbar!\nğŸ’¡ Starten Sie den Server: npm start', 'error');
                setLoading('register', false);
            }
        }

        // ============================================================================
        // VERWENDUNG
        // ============================================================================

        /*
        Ersetze in der HTML diese Zeilen:
        
        Von:
          onclick="handleLogin()"
          onclick="handleRegister()"
        
        Zu:
          onclick="handleLoginWithFallback()"
          onclick="handleRegisterWithFallback()"
        
        JETZT funktioniert:
        âœ… Echter Backend-Login wenn /api/auth/login lÃ¤uft
        âœ… Demo-Mode wenn Backend nicht lÃ¤uft
        âœ… Test-Credentials: admin@test.local / password123
        */
    </script>
</body>

</html>